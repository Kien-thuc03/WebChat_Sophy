<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WebChat Sophy</title>
    <link rel="icon" href="/images/logo.png" />
    <script src="https://www.google.com/recaptcha/api.js?render=6LfBuBMrAAAAAKEtW7E-BdJyvgLTl6ywfO4avdCT"></script>

    <!-- Script ƒë·ªÉ t·∫£i Zego SDK t·ª´ local -->
    <script>
      // Bi·∫øn ƒë·ªÉ theo d√µi tr·∫°ng th√°i t·∫£i SDK
      window.zegoSDKLoading = false;
      window.zegoSDKLoaded = false;

      // H√†m load Zego SDK t·ª´ local
      function loadZegoSDK() {
        // Ki·ªÉm tra xem SDK ƒë√£ ƒë∆∞·ª£c t·∫£i ho·∫∑c ƒëang t·∫£i hay ch∆∞a
        if (window.ZegoExpressEngine) {
          console.log("SDK ƒë√£ ƒë∆∞·ª£c t·∫£i.");
          window.zegoSDKLoaded = true;

          // K√≠ch ho·∫°t s·ª± ki·ªán ƒë·ªÉ th√¥ng b√°o SDK ƒë√£ t·∫£i xong
          const zegoLoadedEvent = new Event("zegoSDKLoaded");
          window.dispatchEvent(zegoLoadedEvent);
          return;
        }

        if (window.zegoSDKLoading) {
          console.log("SDK ƒëang ƒë∆∞·ª£c t·∫£i...");
          return;
        }

        // ƒê√°nh d·∫•u ƒëang t·∫£i SDK
        window.zegoSDKLoading = true;
        console.log("B·∫Øt ƒë·∫ßu t·∫£i Zego SDK t·ª´ local...");

        // Th·ª≠ t·∫£i t·ª´ th∆∞ m·ª•c /zego (file ch√≠nh th·ª©c)
        const script = document.createElement("script");
        script.src = "/zego/ZegoExpressWebRTC.min.js";
        script.async = true;

        script.onload = () => {
          console.log("‚úÖ ƒê√£ t·∫£i SDK ZEGO t·ª´ local th√†nh c√¥ng.");
          window.zegoSDKLoaded = true;
          window.zegoSDKLoading = false;

          // Th√¥ng b√°o cho c√°c component ƒëang ch·ªù SDK
          const zegoLoadedEvent = new Event("zegoSDKLoaded");
          window.dispatchEvent(zegoLoadedEvent);
        };

        script.onerror = () => {
          console.warn(
            "‚ùå Kh√¥ng th·ªÉ t·∫£i SDK ZEGO t·ª´ /zego. Th·ª≠ t·∫£i t·ª´ th∆∞ m·ª•c /lib (b·∫£n d·ª± ph√≤ng)."
          );

          // Th·ª≠ t·∫£i t·ª´ file d·ª± ph√≤ng
          const fallbackScript = document.createElement("script");
          fallbackScript.src = "/lib/ZegoExpressWebRTC.min.js";
          fallbackScript.async = true;

          fallbackScript.onload = () => {
            console.log("‚úÖ ƒê√£ t·∫£i SDK ZEGO d·ª± ph√≤ng t·ª´ /lib th√†nh c√¥ng.");
            window.zegoSDKLoaded = true;
            window.zegoSDKLoading = false;

            // Th√¥ng b√°o cho c√°c component ƒëang ch·ªù SDK
            const zegoLoadedEvent = new Event("zegoSDKLoaded");
            window.dispatchEvent(zegoLoadedEvent);
          };

          fallbackScript.onerror = () => {
            console.error(
              "‚ùå Kh√¥ng th·ªÉ t·∫£i SDK ZEGO t·ª´ c·∫£ hai ngu·ªìn local. Vui l√≤ng ki·ªÉm tra th∆∞ m·ª•c."
            );
            window.zegoSDKLoading = false;

            // Th√¥ng b√°o l·ªói
            alert("Kh√¥ng th·ªÉ t·∫£i th∆∞ vi·ªán cu·ªôc g·ªçi. Vui l√≤ng l√†m m·ªõi trang.");
          };

          document.head.appendChild(fallbackScript);
        };

        document.head.appendChild(script);
      }

      // H√†m kh·ªüi t·∫°o Zego Engine sau khi t·∫£i xong
      function initializeZegoEngine() {
        if (!window.ZegoExpressEngine) {
          console.error("ZegoExpressEngine ch∆∞a s·∫µn s√†ng");
          return null;
        }

        // Kh√¥ng kh·ªüi t·∫°o ngay v√¨ c·∫ßn appID v√† server t·ª´ ph√≠a ·ª©ng d·ª•ng
        console.log("üöÄ ZegoExpressEngine s·∫µn s√†ng ƒë·ªÉ kh·ªüi t·∫°o");
        return true;
      }

      // T·∫£i SDK khi trang v·ª´a t·∫£i xong
      document.addEventListener("DOMContentLoaded", function () {
        // Tr√¨ ho√£n 500ms ƒë·ªÉ tr√°nh tranh ch·∫•p t√†i nguy√™n khi trang ƒëang t·∫£i
        setTimeout(loadZegoSDK, 500);
      });

      // ƒê·∫∑t c√°c h√†m v√†o window ƒë·ªÉ c√≥ th·ªÉ g·ªçi t·ª´ ·ª©ng d·ª•ng
      window.loadZegoSDK = loadZegoSDK;
      window.initializeZegoEngine = initializeZegoEngine;

      // L·∫•y th√¥ng tin Server Zego ƒë·ªÅ xu·∫•t cho khu v·ª±c ch√¢u √Å
      window.ZEGO_SERVER = "wss://webliveroom-ap-singapore.zegocloud.com/ws";
    </script>
    <script src="https://www.google.com/recaptcha/enterprise.js?render=6LfBuBMrAAAAAKEtW7E-BdJyvgLTl6ywfO4avdCT"></script>
  </head>

  <body>
    <div id="root"></div>
    <div id="recaptcha-container"></div>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>
