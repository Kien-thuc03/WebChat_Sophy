(function (window) {
  console.log("ZegoExpressWebRTC mock loading...");

  // Giả lập Zego Engine
  class ZegoExpressEngineImpl {
    constructor() {
      console.log("ZegoExpressEngine mock initialized");
      this.eventHandlers = {};
      this.rooms = new Map();
      this.localStream = null;
      this.remoteStreams = new Map();
    }

    createEngine(config) {
      console.log("ZegoExpressEngine mock createEngine:", config);
      return Promise.resolve();
    }

    on(event, callback) {
      console.log("ZegoExpressEngine mock subscribing to event:", event);
      this.eventHandlers[event] = callback;
      return this;
    }

    off(event) {
      console.log("ZegoExpressEngine mock unsubscribing from event:", event);
      delete this.eventHandlers[event];
      return this;
    }

    loginRoom(roomID, token, user, config) {
      console.log("ZegoExpressEngine mock loginRoom:", {
        roomID,
        token,
        user,
        config,
      });

      // Simulating successful login
      setTimeout(() => {
        this.rooms.set(roomID, { token, user });

        // Dispatch room state update
        if (this.eventHandlers["roomStateUpdate"]) {
          this.eventHandlers["roomStateUpdate"](roomID, "CONNECTED", 0, {});
        }

        // Dispatch user update
        if (this.eventHandlers["roomUserUpdate"]) {
          this.eventHandlers["roomUserUpdate"](roomID, "ADD", [user]);
        }
      }, 500);

      return Promise.resolve();
    }

    logoutRoom(roomID) {
      console.log("ZegoExpressEngine mock logoutRoom:", roomID);
      this.rooms.delete(roomID);
      return Promise.resolve();
    }

    createStream(config) {
      console.log("ZegoExpressEngine mock createStream:", config);

      // Create mock MediaStream
      let mockTracks = [];

      if (config.camera && config.camera.video) {
        mockTracks.push({
          kind: "video",
          enabled: true,
          stop: function () {
            console.log("Video track stopped");
          },
        });
      }

      if (config.camera && config.camera.audio) {
        mockTracks.push({
          kind: "audio",
          enabled: true,
          stop: function () {
            console.log("Audio track stopped");
          },
        });
      }

      this.localStream = {
        getVideoTracks: function () {
          return mockTracks.filter((track) => track.kind === "video");
        },
        getAudioTracks: function () {
          return mockTracks.filter((track) => track.kind === "audio");
        },
        getTracks: function () {
          return mockTracks;
        },
      };

      return Promise.resolve(this.localStream);
    }

    destroyStream(stream) {
      console.log("ZegoExpressEngine mock destroyStream:", stream);
      if (stream) {
        const tracks = stream.getTracks();
        tracks.forEach((track) => track.stop());
      }
    }

    startPublishingStream(streamID, stream) {
      console.log("ZegoExpressEngine mock startPublishingStream:", {
        streamID,
        stream,
      });

      // Dispatch publisher state update
      if (this.eventHandlers["publisherStateUpdate"]) {
        this.eventHandlers["publisherStateUpdate"]({
          state: "PUBLISHING",
          streamID: streamID,
          errorCode: 0,
        });
      }

      return Promise.resolve();
    }

    stopPublishingStream(streamID) {
      console.log("ZegoExpressEngine mock stopPublishingStream:", streamID);

      // Dispatch publisher state update
      if (this.eventHandlers["publisherStateUpdate"]) {
        this.eventHandlers["publisherStateUpdate"]({
          state: "NO_PUBLISH",
          streamID: streamID,
          errorCode: 0,
        });
      }
    }

    startPlayingStream(streamID) {
      console.log("ZegoExpressEngine mock startPlayingStream:", streamID);

      // Create a mock remote stream
      const mockRemoteStream = {
        id: streamID,
        getVideoTracks: function () {
          return [];
        },
        getAudioTracks: function () {
          return [];
        },
        getTracks: function () {
          return [];
        },
      };

      this.remoteStreams.set(streamID, mockRemoteStream);

      // Dispatch player state update
      if (this.eventHandlers["playerStateUpdate"]) {
        this.eventHandlers["playerStateUpdate"]({
          state: "PLAYING",
          streamID: streamID,
          errorCode: 0,
        });
      }

      return Promise.resolve(mockRemoteStream);
    }

    stopPlayingStream(streamID) {
      console.log("ZegoExpressEngine mock stopPlayingStream:", streamID);
      this.remoteStreams.delete(streamID);

      // Dispatch player state update
      if (this.eventHandlers["playerStateUpdate"]) {
        this.eventHandlers["playerStateUpdate"]({
          state: "NO_PLAY",
          streamID: streamID,
          errorCode: 0,
        });
      }
    }
  }

  // Đặt Zego SDK vào window
  window.ZegoExpressEngine = function () {
    return new ZegoExpressEngineImpl();
  };

  console.log("ZegoExpressWebRTC mock loaded successfully!");
})(window);
